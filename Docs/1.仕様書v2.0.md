# GVA Video Platform - 現在の実装状況と仕様書 v2.0

## 1. プロジェクト概要

### 1.1 プロジェクト名
GVA Video Platform（組織向け動画投稿・公開プラットフォーム）

### 1.2 目的
組織内での動画コンテンツの効率的な管理・共有を可能にする専用プラットフォーム

### 1.3 対象ユーザー
- **管理者(ADMIN)**: サイト運営・ユーザー管理を行う担当者、すべての設定権限を持つ
- **投稿者(CURATOR)**: 動画投稿権限のみを持つユーザー
- **視聴者**: 認証不要の匿名ユーザー（組織内外問わず）

## 2. 技術構成

### 2.1 フロントエンド
- **フレームワーク**: Next.js 15 (App Router)
- **言語**: TypeScript
- **スタイリング**: Tailwind CSS
- **UIコンポーネント**: Shadcn/ui + Radix UI
- **状態管理**: React Hooks + Context API
- **フォーム**: React Hook Form + Zod
- **動画プレーヤー**: React Player
- **アイコン**: Lucide React
- **画像処理**: Sharp

### 2.2 バックエンド
- **フレームワーク**: Next.js 15 API Routes
- **データベース**: PostgreSQL + Prisma ORM
- **認証**: JWT + Cookie-based Session
- **ファイルストレージ**: ローカルファイルシステム
- **バリデーション**: Zod
- **キャッシュ**: メモリキャッシュ（Redis準備中）

### 2.3 インフラストラクチャ
- **開発環境**: Node.js 18+
- **パッケージ管理**: npm
- **コード品質**: ESLint + Prettier
- **型チェック**: TypeScript

## 3. 実装済み機能

### 3.1 認証・ユーザー管理 ✅

#### 3.1.1 ログイン機能
- **実装状況**: 完了
- **認証方式**: JWT + Cookie-based Session
- **ユーザー管理**: 管理者による手動アカウント作成
- **権限管理**: ADMIN/CURATOR ロール制御
- **セキュリティ**: ログイン失敗制御実装済み

#### 3.1.2 ユーザー権限管理
- **管理者権限**: 全機能アクセス、ユーザー管理、動画管理
- **投稿者権限**: 動画投稿・編集・削除、自分の動画管理
- **権限制御**: コンポーネントレベルでの権限チェック

#### 3.1.3 ユーザープロフィール機能
- **プロフィール画像**: アップロード・変更機能
- **ユーザー情報編集**: 表示名、メールアドレス、パスワード変更
- **ユーザー紹介文**: 個人ページでの紹介文表示・編集機能
- **ユーザーページ**: `@username`形式のユーザー専用ページ

### 3.2 動画投稿機能 ✅

#### 3.2.1 投稿方法
- **ファイルアップロード**: MP4、MOV、AVI、WebM対応
- **YouTube URL投稿**: YouTube動画のメタデータ自動取得
- **ファイルサイズ制限**: 管理者設定可能（デフォルト5GB）
- **MIME タイプ検証**: 実装済み
- **アップロード進捗表示**: 実装済み

#### 3.2.2 動画変換処理
- **実装状況**: 基本実装済み
- **変換形式**: AV1対応
- **処理フロー**: アップロード → 変換キュー → GPU処理 → 保存
- **変換進捗表示**: 実装済み
- **トランスコードジョブ管理**: 実装済み

#### 3.2.3 サムネイル設定
- **手動アップロード**: 実装済み
- **YouTube自動取得**: 実装済み
- **サムネイル生成**: 実装済み

#### 3.2.4 メタデータ入力
- **動画タイトル**: 必須（100文字以内）
- **説明文**: 必須（1000文字以内）
- **カテゴリ**: 選択式（1動画につき1つ）
- **タグ**: 複数設定可能（1動画につき最大5件）
- **公開設定**: 学外公開/学内限定/非公開

### 3.3 動画視聴機能 ✅

#### 3.3.1 動画プレーヤー
- **基本操作**: 再生、一時停止、音量調整、全画面表示
- **再生速度変更**: 0.5x、1x、1.25x、1.5x、2x
- **YouTube動画対応**: ReactPlayerによるYouTube再生
- **タイムスタンプ機能**: 説明文内のタイムスタンプクリックでシーク
- **自動再生**: タイムスタンプクリック後の自動再生機能

#### 3.3.2 公開制御
- **学外公開**: 全ユーザーが視聴可能
- **学内限定**: 組織内ネットワークのみ視聴可能
- **非公開**: 完全非公開（後から公開可能）

#### 3.3.3 視聴統計
- **視聴回数**: 同一セッション24時間以内は1回のみカウント
- **視聴時間**: 実際の視聴時間を記録
- **完了率**: 動画の何%まで視聴したかを記録
- **匿名統計**: IPアドレス保存なし、セッションIDのみで管理

### 3.4 検索・閲覧機能 ✅

#### 3.4.1 動画一覧表示
- **新着動画**: 投稿日時順
- **人気動画**: 視聴回数順
- **カテゴリ別表示**: カテゴリごとの動画一覧
- **無限スクロール**: 実装済み
- **レスポンシブ対応**: モバイル・タブレット・デスクトップ対応

#### 3.4.2 検索機能
- **キーワード検索**: タイトル・説明文・タグから検索
- **フィルター機能**: カテゴリ別、投稿日期間、タグ別
- **検索履歴**: 検索キーワードの履歴機能
- **統合検索**: 動画の横断検索

### 3.5 レコメンド機能 ✅

#### 3.5.1 基本レコメンド
- **人気動画**: 視聴回数順での動画推薦
- **新着動画**: 最新投稿順での動画表示
- **トレンド動画**: 最近1週間でよく視聴された動画
- **高評価動画**: 視聴完了率の高い動画

#### 3.5.2 表示場所・方式
- **ポータルトップページ**: メインコンテンツとして表示
- **動画視聴ページ**: 関連動画として表示
- **レスポンシブ対応**: デバイスに応じた表示数調整

#### 3.5.3 実装詳細
- **APIエンドポイント**: `/api/videos`でソート機能
- **キャッシュ機能**: メモリキャッシュによる高速化
- **アルゴリズム**: 視聴統計ベースの推薦

### 3.6 管理機能 ✅

#### 3.6.1 動画管理
- **動画一覧**: 全動画の管理画面
- **動画編集**: タイトル、説明、カテゴリ、タグ、公開設定の編集
- **動画削除**: 動画の完全削除
- **公開設定変更**: 学外公開/学内限定/非公開の切り替え
- **サムネイル生成**: 管理画面からのサムネイル生成機能

#### 3.6.2 カテゴリ・タグ管理
- **カテゴリ管理**: カテゴリの作成・編集・削除・並び替え
- **タグ管理**: タグの作成・編集・削除
- **ドラッグ&ドロップ**: カテゴリの並び替え機能

#### 3.6.3 ユーザー管理
- **ユーザー一覧**: 全ユーザーの管理
- **ユーザー作成**: 新規ユーザーの作成
- **権限管理**: ロールの変更
- **アバター管理**: ユーザーアバターの設定
- **コンテンツ移譲**: ユーザー間でのコンテンツ移譲機能

#### 3.6.4 システム設定
- **サイト設定**: サイトタイトル、ロゴ、基本設定
- **アップロード設定**: ファイルサイズ制限、タグ数制限
- **表示設定**: 1ページあたりの表示件数
- **YouTube API設定**: YouTube APIキーの設定
- **GPU変換設定**: GPU変換サーバーの設定
- **セキュリティ設定**: IP制限、画像サイズ制限

#### 3.6.5 統計・分析機能
- **基本統計**: 総動画数、総ユーザー数、総視聴数
- **詳細統計**: 動画ステータス別、ユーザー役割別集計
- **視聴分析**: 平均視聴時間、完了率、人気動画ランキング
- **日別視聴数**: 過去30日間の視聴ログデータ

### 3.7 UI/UX機能 ✅

#### 3.7.1 レスポンシブデザイン
- **モバイル対応**: 完全対応
- **タブレット対応**: 完全対応
- **デスクトップ対応**: 完全対応

#### 3.7.2 テーマ機能
- **ダークモード**: 実装済み
- **ライトモード**: 実装済み
- **テーマ切り替え**: ヘッダーから切り替え可能

#### 3.7.3 ナビゲーション
- **統一ヘッダー**: 全ページで一貫したナビゲーション
- **検索機能**: ヘッダーからの動画検索
- **ユーザーメニュー**: ログアウト、設定、管理画面へのアクセス

## 4. データベース設計

### 4.1 主要テーブル

#### 4.1.1 ユーザー関連
```sql
-- ユーザーテーブル
users (
  id, username, email, password_hash, display_name, bio,
  role, profile_image_url, is_active, created_at, updated_at
)

-- システム設定テーブル
system_settings (
  id, setting_key, setting_value, setting_type, 
  description, is_active, created_at, updated_at
)
```

#### 4.1.2 動画関連
```sql
-- 動画テーブル
videos (
  id, video_id, title, description, upload_type, youtube_url,
  youtube_video_id, file_path, thumbnail_url, duration, 
  view_count, visibility, status, uploader_id, 
  created_at, updated_at, published_at
)

-- 投稿テーブル
posts (
  id, post_id, post_type, title, description, visibility,
  video_id, playlist_id, creator_id, 
  created_at, updated_at, published_at
)

-- カテゴリテーブル
categories (
  id, name, slug, description, color,
  sort_order, created_at, updated_at
)

-- タグテーブル
tags (
  id, name, slug, created_at, updated_at
)

-- 動画カテゴリ関連テーブル
video_categories (video_id, category_id)

-- 動画タグ関連テーブル
video_tags (video_id, tag_id)
```

#### 4.1.3 視聴統計関連
```sql
-- 視聴ログテーブル
view_logs (
  id, video_id, post_id, session_id, 
  watch_time, completion_rate, 
  viewed_at, created_at
)

-- トランスコードジョブテーブル
transcode_jobs (
  id, job_id, video_id, status, progress,
  gpu_server_url, started_at, completed_at,
  error_message, created_at, updated_at
)
```

### 4.2 最新追加機能
- **ユーザー紹介文**: `users.bio`フィールド
- **@username URL**: ユーザー名ベースのURL構造
- **統一APIエンドポイント**: `/api/users/[id]/videos`（ID・username両対応）
- **リダイレクト機能**: 古いURL形式から新形式への自動リダイレクト

## 5. API設計

### 5.1 認証API
- `POST /api/auth/login` - ログイン
- `POST /api/auth/logout` - ログアウト
- `GET /api/auth/me` - 現在のユーザー情報取得

### 5.2 動画API
- `GET /api/videos` - 動画一覧取得（ソート・フィルタ対応）
- `GET /api/videos/[id]` - 動画詳細取得
- `POST /api/upload` - 動画アップロード
- `PUT /api/admin/videos/[id]` - 動画編集
- `DELETE /api/admin/videos/[id]` - 動画削除
- `POST /api/admin/videos/[id]/generate-thumbnail` - サムネイル生成

### 5.3 ユーザーAPI
- `GET /api/users/[id]/videos` - ユーザーの動画一覧（ID・username両対応）
- `GET /api/users/[id]/redirect` - ユーザーID→username変換
- `POST /api/user/profile` - プロフィール更新
- `POST /api/user/avatar` - アバター画像更新

### 5.4 管理API
- `GET /api/admin/stats` - 統計情報取得
- `GET /api/admin/users` - ユーザー一覧取得
- `POST /api/admin/users` - ユーザー作成
- `POST /api/admin/users/[id]/transfer` - コンテンツ移譲
- `GET /api/admin/categories` - カテゴリ一覧取得
- `POST /api/admin/categories` - カテゴリ作成
- `POST /api/admin/categories/reorder` - カテゴリ並び替え

### 5.5 設定API
- `GET /api/settings/public` - 公開設定取得
- `GET /api/admin/settings` - 管理者設定取得
- `PUT /api/admin/settings` - 設定更新
- `POST /api/admin/settings/logo` - ロゴ画像更新

### 5.6 その他API
- `GET /api/categories` - カテゴリ一覧取得
- `GET /api/tags` - タグ一覧取得
- `POST /api/videos/[id]/view-progress` - 視聴進捗記録
- `GET /api/placeholder/[...dimensions]` - プレースホルダー画像生成

## 6. セキュリティ実装

### 6.1 認証・認可
- **JWT認証**: トークンベースの認証
- **権限制御**: ロールベースのアクセス制御
- **セッション管理**: Cookie-based Session
- **CSRF対策**: Next.js標準のCSRF保護

### 6.2 ファイルアップロード
- **MIME タイプ検証**: 許可されたファイル形式のみ
- **ファイルサイズ制限**: 管理者設定可能
- **セキュアなファイル保存**: 安全なディレクトリ構造

### 6.3 データ保護
- **SQLインジェクション対策**: Prisma ORMによる自動エスケープ
- **XSS対策**: React標準のXSS保護
- **入力値検証**: Zodによる型安全なバリデーション
- **IP制限**: プライベート動画のIP制限機能

### 6.4 Content Security Policy
- **CSP設定**: YouTube埋め込み対応のCSP設定
- **画像ドメイン制限**: 信頼できるドメインのみ許可
- **フォント制限**: 必要なフォントのみ許可

## 7. パフォーマンス最適化

### 7.1 フロントエンド
- **Next.js 15 App Router**: サーバーサイドレンダリング
- **動的インポート**: コード分割による最適化
- **画像最適化**: Next.js Image コンポーネント
- **キャッシュ戦略**: 適切なキャッシュヘッダー
- **無限スクロール**: 大量データの効率的な表示

### 7.2 バックエンド
- **データベース最適化**: 適切なインデックス設定
- **クエリ最適化**: Prisma ORMによる効率的なクエリ
- **エラーハンドリング**: 適切なエラー処理とログ
- **メモリキャッシュ**: 統計情報の5分間キャッシュ

### 7.3 動画処理
- **GPU変換**: GPU変換サーバーによる高速処理
- **進捗管理**: トランスコードジョブの進捗管理
- **サムネイル生成**: 効率的なサムネイル生成

## 8. 現在実装中・検討中の機能

### 8.1 プレイリスト機能 🔄
- **データベース設計**: 完了
- **API設計**: 基本設計完了
- **UI実装**: 未実装
- **機能詳細**: プレイリスト作成・管理・視聴機能

### 8.2 高度な検索機能 🔄
- **全文検索**: 実装検討中
- **ファセット検索**: カテゴリ・タグでの絞り込み強化
- **検索結果の最適化**: 関連度順ソート

### 8.3 通知機能 ⏳
- **新着通知**: 未実装
- **メール通知**: 未実装
- **システム通知**: 未実装

### 8.4 多言語対応 ⏳
- **Google Translate ウィジェット**: 実装予定
- **基本言語**: 日本語
- **対応言語**: 英語、韓国語、中国語等

## 9. 未実装機能

### 9.1 高度な動画機能 ❌
- **字幕機能**: 未実装
- **動画編集**: 未実装
- **動画トリミング**: 未実装
- **ライブ配信**: 未実装

### 9.2 ソーシャル機能 ❌
- **コメント機能**: 未実装
- **評価機能**: 未実装
- **フォロー機能**: 未実装

### 9.3 高度な分析機能 ❌
- **詳細統計**: 基本実装済み、高度な分析は未実装
- **レポート生成**: 未実装
- **エクスポート機能**: 未実装
- **機械学習レコメンド**: 未実装

## 10. 技術的負債・改善点

### 10.1 コード品質
- **テストカバレッジ**: 現在テスト未実装、テストの追加が必要
- **型定義**: TypeScriptの型安全性を向上（APIエラー修正済み）
- **エラーハンドリング**: 一部のエラー処理が不十分
- **コンポーネント分割**: メインページの肥大化を解決済み

### 10.2 パフォーマンス
- **キャッシュ最適化**: Redis導入による高速化
- **データベース最適化**: 大規模データ対応
- **バンドルサイズ**: フロントエンドの最適化
- **コンポーネントパフォーマンス**: メインページの大幅な軽量化完了（514行→120行）

### 10.3 セキュリティ
- **入力値検証**: 一部の入力値検証が不十分
- **認証強化**: 2FA等の実装検討
- **監査ログ**: 詳細なアクセスログの実装

## 11. 最新の改善点（v2.0での変更）

### 11.0 パフォーマンス最適化（2025年1月16日）
- **メインページリファクタリング**: 肥大化したコンポーネントの大幅な改善
  - コンポーネントサイズ: 514行 → 120行（76%削減）
  - 新規コンポーネント作成: `SearchFiltersSection`、`VideoListHeader`
  - カスタムフック分離: `useVideoFilters`、`useVideoData`
  - パフォーマンス向上: 体感可能な動作軽量化を実現
  - 型安全性向上: TypeScript型エラーの完全解決
  - 保守性向上: 責務の明確な分離と再利用可能なコンポーネント化

### 11.1 ユーザー体験の向上
- **@username URL**: SEOフレンドリーなURL構造
- **ユーザー紹介文**: 個人ページでの自己紹介機能
- **統一APIエンドポイント**: ID・username両対応の柔軟なAPI
- **リダイレクト機能**: 古いURLからの自動リダイレクト

### 11.2 動画視聴機能の強化
- **タイムスタンプ機能**: 説明文内のタイムスタンプクリック対応
- **自動再生**: タイムスタンプクリック後の自動再生
- **YouTube動画対応**: CSP設定による適切なYouTube埋め込み

### 11.3 管理機能の強化
- **コンテンツ移譲**: ユーザー間でのコンテンツ移譲機能
- **サムネイル生成**: 管理画面からのサムネイル生成
- **設定統一**: 画像サイズ制限等の設定統一
- **不要設定削除**: 不要な設定キーの自動削除

### 11.4 コード最適化
- **重複コード削除**: 共通型定義の統一
- **不要コード削除**: デバッグコードや冗長なコードの削除
- **パフォーマンス改善**: 動画データ変換の最適化
- **メインページリファクタリング**: 大規模コンポーネントの分割とパフォーマンス最適化

## 12. 今後の開発計画

### 12.1 短期計画（1-3ヶ月）
1. **プレイリスト機能の実装**
2. **高度な検索機能の実装**
3. **通知機能の実装**
4. **多言語対応の実装**

### 12.2 中期計画（3-6ヶ月）
1. **字幕機能の実装**
2. **コメント・評価機能の実装**
3. **Redis導入によるキャッシュ最適化**
4. **テストの実装**

### 12.3 長期計画（6ヶ月以上）
1. **機械学習レコメンドの実装**
2. **高度な分析機能の実装**
3. **ライブ配信機能の実装**
4. **モバイルアプリの開発**

## 13. 結論

GVA Video Platformは、組織向け動画プラットフォームとして基本的な機能を実装し、実用的なシステムとして稼働可能な状態にあります。

### 13.1 主な成果
- **完全な動画管理システム**: 投稿から視聴まで一貫したワークフロー
- **高度なユーザー管理**: 権限制御とプロフィール機能
- **効率的な検索・レコメンド**: 視聴統計ベースの推薦機能
- **管理者フレンドリー**: 直感的な管理画面と設定機能
- **モダンなUI/UX**: レスポンシブデザインとダークモード対応

### 13.2 技術的優位性
- **Next.js 15**: 最新のフルスタックフレームワーク
- **型安全性**: TypeScript + Zodによる堅牢な型システム
- **パフォーマンス**: 無限スクロールとキャッシュ最適化
- **セキュリティ**: 包括的なセキュリティ対策

### 13.3 今後の方向性
現在の安定した基盤を活用し、プレイリスト機能や高度な検索機能の実装を通じて、より高機能で使いやすいプラットフォームに発展させることができます。特に、既存のレコメンド機能基盤を活用した機械学習ベースの推薦システムの実装により、ユーザー体験の大幅な向上が期待できます。

---

**文書バージョン**: 2.1  
**作成日**: 2025年7月8日  
**最終更新**: 2025年7月16日  
**承認者**: プロジェクトマネージャー  
**次回レビュー予定**: 次期機能実装完了時 